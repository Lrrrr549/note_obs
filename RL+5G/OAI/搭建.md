# OAI平台搭建

连接`bupt_test`网络

## 1. 核心网docker部署

1. 下载源码

   ```shell
   git clone http://git.opensource5g.org/openxg/openxg-5gcs-release.git
   ```

2. 安装docker、docker-compose

   ```shell
   cd openxg-5gcs-release/scripts
   ./install.sh -I
   ```

3. 创建docker网桥

   ```shell
   docker network create docker-openxg --subnet=172.11.200.0/24 -o com.docker.network.bridge.name=docker-openxg
   ```

4. 启动数据库

   ```shell
   cd openxg-5gcs-release/docker-compose
   docker-compose -f docker-mysql.yml up -d
   ```
   以上命令部署了phpmyadmin，通过访问http://本机ip:8080 可以打开。用户名为：yunshou，密码为：123456；
   用户sim卡信息在 Witcomm-DB数据库 users表中。

5. 在基站主机配置到核心网的静态路由

   在基站所在主机中执行以下命令：

   ```shell
   route add -net 172.11.200.0 netmask 255.255.255.0 gw <核心网所在主机的IP>
   ```

## 2. gNB搭建
### 2.1 环境搭建
**Build UHD**
```bash
sudo apt install -y libboost-all-dev libusb-1.0-0-dev doxygen python3-docutils python3-mako python3-numpy python3-requests python3-ruamel.yaml python3-setuptools cmake build-essential

git clone https://github.com/EttusResearch/uhd.git ~/uhd
cd ~/uhd
git checkout v4.5.0.0
cd host
mkdir build
cd build
cmake ../
make -j $(nproc)
make test # This step is optional
sudo make install
sudo ldconfig
sudo uhd_images_downloader
```
**Build OAI gNB**
```bash
# Get openairinterface5g source code
git clone https://gitlab.eurecom.fr/oai/openairinterface5g.git ~/openairinterface5g
cd ~/openairinterface5g
git checkout develop

# Install OAI dependencies
cd ~/openairinterface5g/cmake_targets
./build_oai -I
```

**OpenAirInterface自带的一些依赖库可能由于网络问题无法下载，可以使用OpenXG本地托管的第三方库，下载并编译安装：**

```bash
git clone http://gitlab.openxg.org.cn/openxg/OpenXG-Install.git
cd OpenXG-Install/
sudo ./install.sh
完成第三方依赖安装后，下载并编译基站源代码：

git clone http://gitlab.openxg.org.cn/openxg/ran.git
git checkout dev  #切换到dev分支
cd ran/
sudo ./build_oai --nrUE --gNB -w OXGRF #使用OXGRF编译基站gNB和终端nrUE
```

### 2.2 gNB启动
```bash
# 检查USRP是否连接
uhd_find_devices

# 启动gNB
cd ran/cmake_targets
sudo ./ran_build/build/nr-softmodem --sa -O ../targets/PROJECTS/GENERIC-NR-5GC/CONF/gnb.sa.band78.fr1.106PRB.usrpb210.conf
```

## 3. CN与gNB连接
### 3.1 核心网
```bash
# 输入如下代码，允许路由表规则 ，每次开机都需再次输入
sudo sysctl net.ipv4.conf.all.forwarding=1
sudo iptables -P FORWARD ACCEPT
```
进入相关yaml文件查看参数：
amf处
```yaml
- MCC: 466
- MNC: 96
- REGION_ID: 128
```
文件内还会有一个十六/十进制的TAC参数，也需要修改。
### 3.2 gNB

**修改gNB配置文件**
```bash
vim gnb.sa.band78.fr1.106PRB.usrpb210.conf
```
```yaml
# Tracking area code, 0x0000 and 0xfffe are reserved values
    tracking_area_code  =  100;
    plmn_list = ({ mcc = 466; mnc = 96; mnc_length = 2; snssaiList = ({ sst = 1 }) });

NETWORK_INTERFACES :
    {
        GNB_INTERFACE_NAME_FOR_NG_AMF            = "<gNB网卡>";
        GNB_IPV4_ADDRESS_FOR_NG_AMF              = "<gNB ip>";
        GNB_INTERFACE_NAME_FOR_NGU               = "<gNB网卡>";
        GNB_IPV4_ADDRESS_FOR_NGU                 = "<gNB ip>";
        GNB_PORT_FOR_S1U                         = 2152; # Spec 2152
    };
```

### 3.3 输出log文件
```bash
docker logs oai-amf > amf.log
docker logs oai-smf > smf.log
```
只列举出了部分，如果gNB与CN连接成功，amf.log中会有明显的显示。

## 4. UE与gNB连接

二者连接主要有两个步骤：

 - 对SIM卡进行编程
 - 修改核心网数据库

### 4.1 SIM卡编程
### 4.2 修改核心网数据库

